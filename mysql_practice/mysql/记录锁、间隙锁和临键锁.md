### 16.MySQL的锁机制 — 记录锁、间隙锁和临键锁
> 记录锁是封锁记录，记录锁也叫行锁。         
> 当用范围条件而不是想等条件查询数据并请求共享或排他锁时，InnoDB会给符合条件的已有数据记录的索引项加锁，对于键值在条件范围内但不存在的记录称为间隙(GAP)，InnoDB也会对这个间隙加锁，这种锁机制就是间隙锁。                                           
  间隙锁是封锁索引记录中的间隔，或者第一条索引记录之前的范围，又或者最后一条索引记录之后的范围。                   
>                                                 
> 间隙锁和行锁合称 next-key lock(邻键锁)，每个 next-key lock 是前开后闭区间。临键锁，是记录锁与间隙锁的组合，它的封锁范围，既包含索引记录，又包含索引区间。                          
  临键锁的主要目的，也是为了避免幻读(Phantom Read)。如果把事务的隔离级别降级为RC，临键锁则也会失效。                                
  记录锁、间隙锁、临键锁都是排它锁。                 
>                           
>间隙锁和行锁有区别，行锁只能被一个事务加上，但是间隙锁可以被多个事务加上。                      
 间隙锁的目的是保护这个间隙不能插入数据，但他们不冲突。                                 
>                       
>加锁规则:                      
 原则1：加锁的基本单位是next-key lock，next-key lock是前开后闭区间。                            
 原则2：查找过程中访问到的对象才会加锁。                           
 优化1：索引上的等值查询，给唯一索引加锁时，next-key lock 退化为行锁。                             
 优化2：索引上的等值查询，向右遍历时且最后一个值不满足等值条件的时候，next-key lock退化为间隙锁。                            
 唯一索引上的范围查询会访问到不满足条件的第一个值为止                                                                                          
>           
> 产生间隙锁的条件（RR事务隔离级别下）:              
  使用普通索引锁定；                 
  使用多列唯一索引；                 
  使用唯一索引锁定多行记录。         
>               
> 对于唯一索引:               
  对于指定查询某一条记录的加锁语句，如果该记录不存在，会产生记录锁和间隙锁，如果记录存在，则只会产生记录锁;                 
  对于查找某一范围内的查询语句，会产生间隙锁。   
>                                       
> 参考 https://zhuanlan.zhihu.com/p/48269420          
