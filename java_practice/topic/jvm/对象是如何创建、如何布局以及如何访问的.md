### 5.对象是如何创建、如何布局以及如何访问的？
> (1).对象的创建             
> 在语言层面上，对象的创建常见方式是new关键字进行创建(还可以通过反射、反序列化、克隆创建)，在jvm内部，jvm碰到new指令以后在内部是如何操作的？                  
  jvm碰到new指令执行流程:                   
  [1].检查指令参数能否在方法区常量池中定位到一个符号引用。如果无法定位到一个符号引用，说明这个类没有定义，将抛出ClassNotFoundException                   
  [2].检查这个符号引用所对应的类有没有被加载，解析和初始化。如果没有，需要执行加载过程。                 
  [3].在类已被加载，解析、初始化以后，需要在堆中为新生对象分配内存。对象在类加载以后，由类生产的对象大小即可确定。                    
  在堆中分配对象空间的方法有指针碰撞法和空闲列表法。对象采用何种分配算法，取决于jvm采用何种垃圾回收算法，标记清除算法适合采用空闲列表，而标记整理，复制算法适合于指针碰撞法。                   
  指针碰撞法：java堆属于规整状态，已用堆内存在一侧，空闲堆内存在另一侧，中间通过指针分割并划分内存，当有新生对象到来时，通过移动指针给新生对象划分特定大小的内存。                    
  这种方法要求java堆必须处于规整状态。                  
  空闲列表法：堆内存可以不规整，此时需要通过一个空闲列表记录在堆内存中存在的空闲空间。当有新生代对象到来时，通过查看空闲列表，找到适合对象大小的内存空间，将空间分配给该对象，并修改空闲列表。                
  这种方法需要划出额外的空间用于维护空闲列表。                    
  [4].为对象中的成员变量赋上默认初始值                  
  [5].设置对象头信息，对象是属于哪个类的实例，对象的哈希码，对象的GC分代年龄等             
  [6].调用对象的构造函数进行初始化。 
>                                     
> (2).对象在内存中的布局             
  在hotspot虚拟机中，对象在内存中的布局分为三个部分:对象头(Header)、实例数据(Instance Data)和对齐填充(Padding)。           
  对象头               
  存储对象在运行中需要用到的数据：哈希码、GC分代年龄、锁状态标志、线程持有的锁、线程偏向ID、偏向时间戳等；                
  类型指针：对象指向其类元数据的指针，虚拟机通过这个指针确定这个对象是哪个类的实例；             
  如果对象是数组，对象头中还有一块区域用于保存数组大小；               
  实例数据              
  存放的是对象各种类型字段的值，包括父类成员变量，子类成员变量            
  对齐填充          
  hotspot jvm要求对象起始地址必须是8字节的整数倍，所以要保证一个对象所占的内存是8的整数倍，由于对象头正好是8的整数倍，所以通过填充实例数据使其成为8字节的整数倍，使对象对齐。             
>                            
> (3).对象的访问定位                   
  使用对象时，通过栈上的reference数据来操作堆上的具体对象。                 
  在jvm中有2种对象定位方式，一种是句柄访问，一种是直接地址访问。             
  句柄访问                  
  java堆中划分出一块内存作为句柄池，虚拟机栈中存储的是对象的句柄地址，句柄中包含了对象的实例地址和元数据地址。访问对象时，先根据对象引用找到句柄池地址，再根据句柄池中的对象数据地址找到对象。              
> ![object_ref1](http://github.com/xidianlina/practice/raw/master//java_practice/topic/picture/object_ref1.png)                                                           
> 直接地址访问                
  虚拟机栈中的引用存储的是对象在堆内存中的地址，通过该地址直接定位到对象，不需要经过中间媒介，更加快速，但是在对象的内存结构中需要存储对象的类型指针，用于定位方法区的对象类型。               
> ![object_ref2](http://github.com/xidianlina/practice/raw/master//java_practice/topic/picture/object_ref2.png)                                                     
  比较:使用句柄的最大好处是 reference 中存储的是稳定的句柄地址，在对象移动(GC)时只改变实例数据指针地址，reference 自身不需要修改。             
> 直接指针访问的最大好处是速度快，因为它只需要一次寻址操作,节省了一次指针定位的时间开销。但它在对象内存结构中需要额外存储类型指针。
  如果是对象频繁GC那么句柄方法好，如果是对象频繁访问则直接指针访问好。hotspot采用的对象访问方式就是直接地址访问。      